"""
将推理过程转换为模型序列
基于关键词匹配和模式识别
"""
import json
import re

# 模型关键词映射规则
MODEL_PATTERNS = {
    # 曲线定义 (0-2)
    0: [r'椭圆.*定义', r'\|PF[_₁₂]+\|\s*\+\s*\|PF[_₁₂]+\|', r'两焦点.*距离.*和', r'到.*焦点.*距离.*和'],
    1: [r'双曲线.*定义', r'\|\|PF[_₁₂]+\|\s*-\s*\|PF[_₁₂]+\|\|', r'两焦点.*距离.*差', r'到.*焦点.*距离.*差'],
    2: [r'抛物线.*定义', r'焦点.*距离.*准线.*距离', r'到焦点.*距离.*到.*准线', r'\|PF\|\s*=\s*d', r'\|PF\|\s*=\s*\|P'],
    
    # 标准方程 (3-10)
    3: [r'椭圆.*焦点在x轴', r'\\frac\{x\^?\{2\}\}\{[a-z0-9²]+\}\s*\+\s*\\frac\{y\^?\{2\}\}\{[a-z0-9²]+\}\s*=\s*1'],
    4: [r'椭圆.*焦点在y轴', r'\\frac\{y\^?\{2\}\}\{[a-z0-9²]+\}\s*\+\s*\\frac\{x\^?\{2\}\}\{[a-z0-9²]+\}\s*=\s*1'],
    5: [r'双曲线.*焦点在x轴', r'\\frac\{x\^?\{2\}\}\{[a-z0-9²]+\}\s*-\s*\\frac\{y\^?\{2\}\}\{[a-z0-9²]+\}\s*=\s*1'],
    6: [r'双曲线.*焦点在y轴', r'\\frac\{y\^?\{2\}\}\{[a-z0-9²]+\}\s*-\s*\\frac\{x\^?\{2\}\}\{[a-z0-9²]+\}\s*=\s*1'],
    7: [r'y\^?\{?2\}?\s*=\s*2px', r'y²\s*=', r'抛物线.*开口向右'],
    9: [r'x\^?\{?2\}?\s*=\s*2py', r'x²\s*=.*y', r'抛物线.*开口向上'],
    10: [r'x\^?\{?2\}?\s*=\s*-2py', r'抛物线.*开口向下'],
    
    # 参数关系与离心率 (11-15)
    11: [r'a\^?\{?2\}?\s*=\s*b\^?\{?2\}?\s*\+\s*c\^?\{?2\}?', r'椭圆.*a.*b.*c'],
    12: [r'c\^?\{?2\}?\s*=\s*a\^?\{?2\}?\s*\+\s*b\^?\{?2\}?', r'双曲线.*a.*b.*c'],
    13: [r'e\s*=\s*\\frac\{c\}\{a\}', r'离心率', r'e=\s*\\frac'],
    14: [r'0\s*<\s*e\s*<\s*1', r'椭圆.*离心率.*范围'],
    15: [r'e\s*>\s*1', r'双曲线.*离心率.*范围'],
    
    # 焦半径与通径 (16-20)
    16: [r'椭圆.*焦半径', r'\|PF\|\s*=\s*a\s*±\s*ex'],
    17: [r'抛物线.*焦半径', r'\|PF\|\s*=\s*x\s*\+\s*\\frac\{p\}\{2\}', r'x.*\+.*\\frac\{p\}\{2\}'],
    18: [r'椭圆.*通径', r'\\frac\{2b\^?\{?2\}?\}\{a\}.*椭圆'],
    19: [r'双曲线.*通径', r'\\frac\{2b\^?\{?2\}?\}\{a\}.*双曲线', r'过焦点.*垂直.*实轴'],
    20: [r'抛物线.*通径', r'2p(?!x|y)'],
    
    # 渐近线相关 (21-24)
    21: [r'渐近线', r'y\s*=\s*±.*\\frac\{b\}\{a\}'],
    22: [r'焦点.*渐近线.*距离.*b', r'd\s*=\s*b'],
    23: [r'共渐近线', r'渐近线系'],
    24: [r'等轴双曲线', r'a\s*=\s*b.*e\s*=\s*\\sqrt\{2\}'],
    
    # 第二定义与准线 (25-29)
    25: [r'椭圆.*第二定义', r'\|PF\|/d\s*=\s*e.*椭圆'],
    26: [r'双曲线.*第二定义', r'\|PF\|/d\s*=\s*e.*双曲线'],
    27: [r'椭圆.*准线', r'x\s*=\s*±\\frac\{a\^?\{?2\}?\}\{c\}'],
    28: [r'双曲线.*准线', r'准线.*双曲线'],
    29: [r'抛物线.*准线', r'准线方程.*=\s*-\\frac\{p\}\{2\}', r'x\s*=\s*-', r'准线'],
    
    # 焦点三角形 (30-32)
    30: [r'椭圆.*焦点三角形.*面积', r'S\s*=\s*b\^?\{?2\}?.*tan'],
    31: [r'双曲线.*焦点三角形.*面积', r'S\s*=\s*b\^?\{?2\}?.*cot'],
    32: [r'椭圆.*焦点三角形.*周长', r'4a\s*=', r'周长.*2a\s*\+\s*2c'],
    
    # 抛物线焦点弦 (33-36)
    33: [r'焦点弦.*\|AB\|.*x[_₁₂]+.*\+.*x[_₁₂]+.*\+.*p', r'x[_₁₂]+.*\+.*x[_₁₂]+.*\+.*p'],
    34: [r'x[_₁₂]+x[_₁₂]+.*=.*p\^?\{?2\}?/4', r'焦点弦.*横坐标.*积'],
    35: [r'y[_₁₂]+y[_₁₂]+.*=.*-p\^?\{?2\}?', r'焦点弦.*纵坐标.*积'],
    36: [r'\|AB\|.*=.*\\frac\{2p\}\{.*sin\^?\{?2\}?', r'焦点弦.*角度'],
    
    # 韦达定理 (41-43)
    41: [r'韦达定理', r'根与系数'],
    42: [r'x[_₁₂]+.*\+.*x[_₁₂]+.*=', r'y[_₁₂]+.*\+.*y[_₁₂]+.*=', r'两根.*和'],
    43: [r'x[_₁₂]+.*x[_₁₂]+.*=', r'y[_₁₂]+.*y[_₁₂]+.*=', r'两根.*积'],
    
    # 点差法 (44-46)
    44: [r'点差法', r'两式相减', r'代入.*相减'],
    45: [r'点差法.*椭圆', r'椭圆.*点差'],
    46: [r'点差法.*双曲线', r'双曲线.*点差'],
    
    # 三角形定理 (47-49)
    47: [r'余弦定理', r'c\^?\{?2\}?\s*=\s*a\^?\{?2\}?\s*\+\s*b\^?\{?2\}?\s*-\s*2ab.*cos'],
    48: [r'正弦定理', r'\\frac\{a\}\{sin'],
    49: [r'勾股定理', r'a\^?\{?2\}?\s*\+\s*b\^?\{?2\}?\s*=\s*c\^?\{?2\}?(?!-)'],
    
    # 弦长公式 (50-51)
    50: [r'弦长公式', r'\|AB\|.*=.*\\sqrt.*\(x[_₁₂]+.*\+.*x[_₁₂]+\)'],
    51: [r'\|AB\|.*=.*\\sqrt\{.*1\s*\+\s*k\^?\{?2\}?'],
    
    # 距离与坐标 (52-55)
    52: [r'点到直线.*距离', r'd\s*=\s*\\frac\{.*\}\{\\sqrt'],
    53: [r'两点.*距离', r'd\s*=\s*\\sqrt\[\(x', r'\|AB\|.*=.*\\sqrt\[\('],
    54: [r'中点', r'\\frac\{x[_₁₂]+.*\+.*x[_₁₂]+\}\{2\}'],
    55: [r'斜率', r'k\s*=\s*\\frac\{y[_₁₂]+-y[_₁₂]+\}'],
    
    # 三角形面积 (56-58)
    56: [r'S\s*=\s*\\frac\{1\}\{2\}.*底.*高', r'面积.*底.*高'],
    57: [r'S\s*=\s*\\frac\{1\}\{2\}.*sin', r'面积.*sin'],
    58: [r'S\s*=\s*\\frac\{1\}\{2\}\|x[_₁₂]+y[_₁₂]+-x[_₁₂]+y[_₁₂]+\|'],
    
    # 向量运算 (59-62)
    59: [r'\\overrightarrow.*=.*x[_₁₂]+x[_₁₂]+.*\+.*y[_₁₂]+y[_₁₂]+', r'向量.*数量积.*代数'],
    60: [r'\\overrightarrow.*=.*\|.*\|.*\|.*\|.*cos', r'向量.*数量积.*几何'],
    61: [r'\\overrightarrow.*\\cdot.*=\s*0', r'\\bot', r'垂直', r'k[_₁₂]+.*k[_₁₂]+.*=\s*-1'],
    62: [r'\\overrightarrow.*=.*\\lambda', r'共线', r'平行'],
    
    # 不等式 (63-64)
    63: [r'基本不等式', r'a\s*\+\s*b\s*≥\s*2\\sqrt', r'≥.*2\\sqrt'],
    64: [r'当且仅当', r'取等.*条件'],
    
    # 判别式 (65-67)
    65: [r'[ΔA]\s*=\s*b\^?\{?2\}?\s*-\s*4ac', r'判别式'],
    66: [r'[ΔA]\s*=\s*0.*相切', r'相切'],
    67: [r'[ΔA]\s*>\s*0', r'相交.*两.*交点'],
    
    # 中位线定理 (68-69)
    68: [r'三角形.*中位线', r'中位线.*底边/2'],
    69: [r'梯形.*中位线', r'中位线.*上底.*下底'],
    
    # 内切圆和等积法 (70-71)
    70: [r'内切圆', r'r\s*=\s*\\frac\{2S\}\{周长\}'],
    71: [r'等积法', r'等底.*等高'],
    
    # 直线方程 (72-74)
    72: [r'点斜式', r'y\s*-\s*y[_₀₁₂]+\s*=\s*k\(x\s*-\s*x[_₀₁₂]+\)'],
    73: [r'两点式'],
    74: [r'截距式', r'\\frac\{x\}\{.*\}\s*\+\s*\\frac\{y\}'],
    
    # 圆相关 (75-76)
    75: [r'圆.*标准方程', r'\(x-[^)]+\)\^?\{?2\}?\s*\+\s*\(y-[^)]+\)\^?\{?2\}?\s*=\s*r'],
    76: [r'圆.*相切.*d\s*=\s*r'],
    
    # 高级技巧 (77-79)
    77: [r'齐次化', r'同除以\s*a\^?\{?2\}?', r'两边.*除以.*a\^?\{?2\}?'],
    78: [r'x\s*=\s*my\s*\+', r'设.*x\s*=.*y'],
    79: [r'配方', r'最值.*二次函数'],
}

# 通用关键词（高频）
GENERAL_PATTERNS = {
    '联立方程': [r'联立', r'\\begin\{cases\}'],
    '消元': [r'消去', r'消元'],
    '化简': [r'化简', r'整理得'],
    '解方程': [r'解得', r'求解'],
    '代入': [r'代入', r'将.*代入'],
}

def identify_models(process_text):
    """识别推理过程中使用的模型"""
    models = []
    
    # 检查每个模型的关键词
    for model_id, patterns in MODEL_PATTERNS.items():
        for pattern in patterns:
            if re.search(pattern, process_text, re.IGNORECASE):
                if model_id not in models:
                    models.append(model_id)
                break
    
    return sorted(models)

def parse_process_file(input_file):
    """解析推理过程文件"""
    result = {}
    
    with open(input_file, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            
            # 提取ID和推理过程
            match = re.match(r'\[(\d+)\]\s*(.*)', line)
            if match:
                sample_id = match.group(1)
                process = match.group(2)
                
                # 识别使用的模型
                models = identify_models(process)
                result[sample_id] = models
    
    return result

def main():
    input_file = 'data/data_process/train_process_part_1.txt'
    output_file = 'data/data_process/process_models_part_1.json'
    
    print(f"正在处理文件: {input_file}")
    result = parse_process_file(input_file)
    
    print(f"已处理 {len(result)} 个样本")
    print(f"样本示例:")
    for i, (sample_id, models) in enumerate(list(result.items())[:5]):
        print(f"  [{sample_id}]: {models}")
    
    # 保存结果
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)
    
    print(f"\n结果已保存到: {output_file}")
    
    # 统计信息
    total_models = sum(len(models) for models in result.values())
    avg_models = total_models / len(result) if result else 0
    print(f"\n统计信息:")
    print(f"  总样本数: {len(result)}")
    print(f"  平均每个样本使用模型数: {avg_models:.2f}")

if __name__ == '__main__':
    main()

